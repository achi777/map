<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8">
    <title th:text="${title}">Simple Interactive Map</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
        }
        #map {
            height: 100vh;
            width: 100%;
        }
        .control-icons {
            position: absolute;
            top: 15px;
            right: 15px;
            z-index: 1001;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .control-icon {
            width: 50px;
            height: 50px;
            background: white;
            border-radius: 50%;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 24px;
            transition: all 0.3s ease;
            border: 3px solid transparent;
        }
        .control-icon:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(0,0,0,0.4);
        }
        .control-icon.active {
            border-color: #007bff;
            background: #e3f2fd;
        }
        .control-panel {
            position: absolute;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            z-index: 1000;
            padding: 20px;
            display: none;
            max-width: 400px;
            min-width: 300px;
        }
        .control-panel.show {
            display: block;
            animation: slideIn 0.3s ease;
        }
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .control-panel h4 {
            margin: 0 0 15px 0;
            padding-bottom: 10px;
            border-bottom: 2px solid #f0f0f0;
            color: #333;
        }
        .panel-close {
            position: absolute;
            top: 10px;
            right: 15px;
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: #666;
            padding: 5px;
        }
        .panel-close:hover {
            color: #333;
        }
        #info-panel {
            top: 80px;
            right: 15px;
        }
        #layers-panel {
            top: 80px;
            right: 15px;
        }
        #factory-panel {
            top: 80px;
            right: 15px;
            max-height: 500px;
            overflow-y: auto;
        }
        #routing-panel {
            bottom: 15px;
            right: 15px;
        }
        .routing-controls input {
            width: 100%;
            margin: 5px 0;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 3px;
        }
        .routing-controls button {
            background: #28a745;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 3px;
            cursor: pointer;
            margin: 5px 5px 5px 0;
        }
        .routing-controls button:hover {
            background: #218838;
        }
        .routing-controls button.secondary {
            background: #6c757d;
        }
        .routing-controls button.secondary:hover {
            background: #5a6268;
        }
        .transport-modes {
            display: flex;
            justify-content: space-between;
            margin: 10px 0;
        }
        .transport-mode {
            display: flex;
            align-items: center;
            margin-right: 15px;
        }
        .transport-mode input[type="radio"] {
            margin-right: 5px;
        }
        .route-info {
            margin-top: 15px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 5px;
            border-left: 4px solid #007bff;
        }
        .hidden {
            display: none;
        }
        .success {
            color: #28a745;
            font-weight: bold;
        }
        .layer-control {
            display: flex;
            align-items: center;
            margin: 8px 0;
        }
        .layer-control input[type="checkbox"] {
            margin-right: 8px;
        }
        .layer-control label {
            font-size: 14px;
            cursor: pointer;
        }
        .factory-form {
            margin-bottom: 15px;
        }
        .factory-form input, .factory-form select {
            width: 100%;
            margin: 5px 0;
            padding: 5px;
            border: 1px solid #ddd;
            border-radius: 3px;
            font-size: 12px;
        }
        .factory-form button {
            background: #007bff;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 3px;
            cursor: pointer;
            margin: 2px;
            font-size: 12px;
        }
        .factory-form button:hover {
            background: #0056b3;
        }
        .factory-form button.delete {
            background: #dc3545;
        }
        .factory-form button.delete:hover {
            background: #c82333;
        }
        .factory-list {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 3px;
            padding: 5px;
        }
        .factory-item {
            padding: 5px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            font-size: 12px;
        }
        .factory-item:hover {
            background: #f8f9fa;
        }
        .factory-item.selected {
            background: #e3f2fd;
        }
    </style>
</head>
<body>
    <!-- Control Icons -->
    <div class="control-icons">
        <div class="control-icon" onclick="togglePanel('info-panel', this)" title="ინფორმაცია">
            ℹ️
        </div>
        <div class="control-icon" onclick="togglePanel('layers-panel', this)" title="ლეიერები">
            📍
        </div>
        <div class="control-icon" onclick="togglePanel('factory-panel', this)" title="ქარხნების მართვა">
            🏭
        </div>
        <div class="control-icon" onclick="togglePanel('roads-panel', this)" title="გზების მართვა">
            🛣️
        </div>
        <div class="control-icon" onclick="togglePanel('forests-panel', this)" title="ტყეების მართვა">
            🌲
        </div>
        <div class="control-icon" onclick="togglePanel('routing-panel', this)" title="მარშრუტის დაგეგმვა">
            🚗
        </div>
    </div>

    <!-- Info Panel -->
    <div id="info-panel" class="control-panel">
        <button class="panel-close" onclick="closePanel('info-panel')">×</button>
        <h4>🗺️ Simple Interactive Map</h4>
        <p>საქართველოს ინტერაქტიული რუქა</p>
        <p class="success">✅ Map is working!</p>
        <small>OpenStreetMap-ის სტილის ნავიგაციით</small>
    </div>

    <!-- Layers Panel -->
    <div id="layers-panel" class="control-panel">
        <button class="panel-close" onclick="closePanel('layers-panel')">×</button>
        <h4>📍 Layer-ები</h4>
        <div class="layer-control">
            <input type="checkbox" id="roads-layer" checked onchange="toggleLayer('roads')">
            <label for="roads-layer">🛣️ გზები</label>
        </div>
        <div class="layer-control">
            <input type="checkbox" id="forests-layer" checked onchange="toggleLayer('forests')">
            <label for="forests-layer">🌲 ტყეები</label>
        </div>
        <div class="layer-control">
            <input type="checkbox" id="factories-layer" checked onchange="toggleLayer('factories')">
            <label for="factories-layer">🏭 ქარხნები</label>
        </div>
    </div>

    <!-- Factory Management Panel -->
    <div id="factory-panel" class="control-panel">
        <button class="panel-close" onclick="closePanel('factory-panel')">×</button>
        <h4>🏭 ქარხნების მართვა</h4>
        <div id="geoserver-status" style="font-size: 12px; margin-bottom: 10px; padding: 5px; border-radius: 3px;">
            <span id="geoserver-indicator">🔄 GeoServer-ის სტატუსის შემოწმება...</span>
        </div>
        
        <div class="factory-form">
            <input type="text" id="factory-name" placeholder="ქარხნის დასახელება" />
            <select id="factory-type">
                <option value="">ქარხნის ტიპი</option>
                <option value="ტექსტილი">ტექსტილი</option>
                <option value="საკვები">საკვები</option>
                <option value="ქიმია">ქიმია</option>
                <option value="ელექტრონიკა">ელექტრონიკა</option>
                <option value="ლითონი">ლითონი</option>
                <option value="სხვა">სხვა</option>
            </select>
            <select id="factory-status">
                <option value="">სტატუსი</option>
                <option value="აქტიური">აქტიური</option>
                <option value="შეჩერებული">შეჩერებული</option>
                <option value="დახურული">დახურული</option>
            </select>
            <input type="number" id="factory-capacity" placeholder="მოცულობა" />
            <input type="number" id="factory-lat" placeholder="განედი (latitude)" step="0.000001" />
            <input type="number" id="factory-lng" placeholder="გრძედი (longitude)" step="0.000001" />
            
            <button onclick="saveFactory()">შენახვა</button>
            <button onclick="clearForm()">გაწმენდა</button>
            <button onclick="deleteSelectedFactory()" class="delete" id="delete-btn" style="display:none;">წაშლა</button>
        </div>
        
        <div class="factory-list" id="factory-list">
            <!-- Factory list will be populated here -->
        </div>
    </div>

    <!-- Roads Management Panel -->
    <div id="roads-panel" class="control-panel">
        <button class="panel-close" onclick="closePanel('roads-panel')">×</button>
        <h4>🛣️ გზების მართვა</h4>
        
        <div class="factory-form">
            <input type="text" id="road-name" placeholder="გზის დასახელება" />
            <select id="road-type">
                <option value="">გზის ტიპი</option>
                <option value="მთავარი გზა">მთავარი გზა</option>
                <option value="მეორადი გზა">მეორადი გზა</option>
                <option value="ადგილობრივი გზა">ადგილობრივი გზა</option>
                <option value="ტროტუარი">ტროტუარი</option>
            </select>
            <select id="road-material">
                <option value="">მასალა</option>
                <option value="ასფალტი">ასფალტი</option>
                <option value="ბეტონი">ბეტონი</option>
                <option value="ბიტუმი">ბიტუმი</option>
                <option value="ღია ნიადაგი">ღია ნიადაგი</option>
            </select>
            <input type="number" id="road-startLat" placeholder="საწყისი განედი" step="0.000001" />
            <input type="number" id="road-startLng" placeholder="საწყისი გრძედი" step="0.000001" />
            <input type="number" id="road-endLat" placeholder="საბოლოო განედი" step="0.000001" />
            <input type="number" id="road-endLng" placeholder="საბოლოო გრძედი" step="0.000001" />
            <input type="number" id="road-length" placeholder="სიგრძე (კმ)" step="0.1" />
            
            <button onclick="saveRoad()">შენახვა</button>
            <button onclick="clearRoadForm()">გაწმენდა</button>
            <button onclick="deleteSelectedRoad()" class="delete" id="road-delete-btn" style="display:none;">წაშლა</button>
        </div>
        
        <div class="factory-list" id="road-list">
            <!-- Road list will be populated here -->
        </div>
    </div>

    <!-- Forests Management Panel -->
    <div id="forests-panel" class="control-panel">
        <button class="panel-close" onclick="closePanel('forests-panel')">×</button>
        <h4>🌲 ტყეების მართვა</h4>
        
        <div class="factory-form">
            <input type="text" id="forest-name" placeholder="ტყის დასახელება" />
            <select id="forest-type">
                <option value="">ტყის ტიპი</option>
                <option value="ბუნებრივი ტყე">ბუნებრივი ტყე</option>
                <option value="რეკრეაციული">რეკრეაციული</option>
                <option value="საქალაქო პარკი">საქალაქო პარკი</option>
                <option value="დაცული ტერიტორია">დაცული ტერიტორია</option>
            </select>
            <select id="forest-density">
                <option value="">სიმჭიდროვე</option>
                <option value="მაღალი">მაღალი</option>
                <option value="საშუალო">საშუალო</option>
                <option value="დაბალი">დაბალი</option>
            </select>
            <select id="forest-status">
                <option value="">სტატუსი</option>
                <option value="დაცული">დაცული</option>
                <option value="შეუზღუდავი">შეუზღუდავი</option>
                <option value="რესტორაცია">რესტორაცია</option>
            </select>
            <input type="number" id="forest-area" placeholder="ფართობი (ჰა)" step="0.1" />
            <input type="number" id="forest-centerLat" placeholder="ცენტრის განედი" step="0.000001" />
            <input type="number" id="forest-centerLng" placeholder="ცენტრის გრძედი" step="0.000001" />
            
            <button onclick="saveForest()">შენახვა</button>
            <button onclick="clearForestForm()">გაწმენდა</button>
            <button onclick="deleteSelectedForest()" class="delete" id="forest-delete-btn" style="display:none;">წაშლა</button>
        </div>
        
        <div class="factory-list" id="forest-list">
            <!-- Forest list will be populated here -->
        </div>
    </div>

    <!-- Routing Panel -->
    <div id="routing-panel" class="control-panel">
        <button class="panel-close" onclick="closePanel('routing-panel')">×</button>
        <h4>🚗 მარშრუტის დაგეგმვა</h4>
        
        <div class="routing-controls">
            <input type="text" id="start-location" placeholder="საწყისი წერტილი (კლიკით)" readonly />
            <button onclick="setStartLocation()">საწყისი წერტილი</button>
            
            <input type="text" id="end-location" placeholder="დანიშნულების წერტილი (კლიკით)" readonly />
            <button onclick="setEndLocation()">დანიშნულება</button>
            
            <div class="transport-modes">
                <div class="transport-mode">
                    <input type="radio" id="driving" name="route-type" value="driving" checked />
                    <label for="driving">🚗 მანქანა</label>
                </div>
                <div class="transport-mode">
                    <input type="radio" id="walking" name="route-type" value="walking" />
                    <label for="walking">🚶 ფეხით</label>
                </div>
                <div class="transport-mode">
                    <input type="radio" id="cycling" name="route-type" value="cycling" />
                    <label for="cycling">🚴 ველოსიპედით</label>
                </div>
            </div>
            
            <button onclick="calculateRoute()">მარშრუტის ძებნა</button>
            <button onclick="clearRoute()" class="secondary">გაწმენდა</button>
        </div>
        
        <div id="route-info" class="route-info hidden">
            <!-- Route information will be displayed here -->
        </div>
    </div>
    
    <div id="map"></div>
    
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // Initialize map centered on Tbilisi, Georgia
        const map = L.map('map').setView([41.7151, 44.8271], 13);

        // Add OpenStreetMap tiles
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap contributors'
        }).addTo(map);

        // Add marker for Tbilisi
        L.marker([41.7151, 44.8271]).addTo(map)
            .bindPopup('<b>თბილისი</b><br>საქართველოს დედაქალაქი')
            .openPopup();

        // Routing variables
        let routingMode = null;
        let startLocation = null;
        let endLocation = null;
        let currentRoute = null;
        let startMarker = null;
        let endMarker = null;

        // Layer variables
        let roadsLayer = null;
        let forestsLayer = null;
        let factoriesLayer = null;

        // Management variables
        let selectedFactoryId = null;
        let factoriesData = [];
        let selectedRoadId = null;
        let roadsData = [];
        let selectedForestId = null;
        let forestsData = [];

        // Routing functions
        function setStartLocation() {
            routingMode = 'start';
            map.getContainer().style.cursor = 'crosshair';
            alert('კლიკი ნახეთ რუქაზე საწყისი წერტილის ასარჩევად');
        }

        function setEndLocation() {
            routingMode = 'end';
            map.getContainer().style.cursor = 'crosshair';
            alert('კლიკი ნახეთ რუქაზე დანიშნულების წერტილის ასარჩევად');
        }

        function calculateRoute() {
            if (!startLocation || !endLocation) {
                alert('გთხოვთ აირჩიოთ საწყისი და საბოლოო წერტილები');
                return;
            }
            
            // Clear previous route
            if (currentRoute) {
                map.removeLayer(currentRoute);
            }
            
            // Get selected transport mode
            const routeType = document.querySelector('input[name="route-type"]:checked').value;
            
            // Try OSRM routing service
            const start = `${startLocation.lng},${startLocation.lat}`;
            const end = `${endLocation.lng},${endLocation.lat}`;
            
            const profileMap = {
                'driving': 'driving',
                'walking': 'foot',
                'cycling': 'bike'
            };
            
            const profile = profileMap[routeType] || 'driving';
            const url = `https://router.project-osrm.org/route/v1/${profile}/${start};${end}?geometries=geojson&overview=full`;
            
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    if (data.routes && data.routes.length > 0) {
                        drawRoute(data.routes[0], routeType);
                    } else {
                        drawSimpleRoute();
                    }
                })
                .catch(() => {
                    console.log('OSRM failed, drawing simple line');
                    drawSimpleRoute();
                });
        }

        function drawRoute(route, routeType) {
            const coordinates = route.geometry.coordinates.map(coord => [coord[1], coord[0]]);
            
            const colorMap = {
                'driving': '#007bff',
                'walking': '#28a745', 
                'cycling': '#ffc107'
            };
            
            currentRoute = L.polyline(coordinates, {
                color: colorMap[routeType] || '#007bff',
                weight: 6,
                opacity: 0.8
            }).addTo(map);
            
            const distance = (route.distance / 1000).toFixed(2);
            const duration = Math.round(route.duration / 60);
            
            const transportNames = {
                'driving': 'მანქანა',
                'walking': 'ფეხით',
                'cycling': 'ველოსიპედით'
            };
            
            const routeInfo = document.getElementById('route-info');
            routeInfo.innerHTML = `
                <strong>მარშრუტის ინფორმაცია:</strong><br>
                <strong>მანძილი:</strong> ${distance} კმ<br>
                <strong>დრო:</strong> ${duration} წუთი<br>
                <strong>ტრანსპორტი:</strong> ${transportNames[routeType]}<br>
                <small>რეალური მარშრუტი OpenStreetMap-ის მიხედვით</small>
            `;
            routeInfo.classList.remove('hidden');
            
            // Fit map to show the route
            const group = new L.featureGroup([startMarker, endMarker, currentRoute]);
            map.fitBounds(group.getBounds().pad(0.1));
        }

        function drawSimpleRoute() {
            const latlngs = [startLocation, endLocation];
            
            currentRoute = L.polyline(latlngs, {
                color: '#ff6b35',
                weight: 6,
                opacity: 0.8,
                dashArray: '10, 10'
            }).addTo(map);
            
            const distance = (startLocation.distanceTo(endLocation) / 1000).toFixed(2);
            
            const routeInfo = document.getElementById('route-info');
            routeInfo.innerHTML = `
                <strong>მარშრუტის ინფორმაცია:</strong><br>
                <strong>მანძილი:</strong> ~${distance} კმ (პირდაპირი ხაზი)<br>
                <strong>ტიპი:</strong> გამარტივებული მარშრუტი<br>
                <small>ნაჩვენებია პირდაპირი ხაზი ორ წერტილს შორის</small>
            `;
            routeInfo.classList.remove('hidden');
            
            // Fit map to show the route
            const group = new L.featureGroup([startMarker, endMarker, currentRoute]);
            map.fitBounds(group.getBounds().pad(0.1));
        }

        function clearRoute() {
            if (currentRoute) {
                map.removeLayer(currentRoute);
                currentRoute = null;
            }
            
            if (startMarker) {
                map.removeLayer(startMarker);
                startMarker = null;
                startLocation = null;
            }
            
            if (endMarker) {
                map.removeLayer(endMarker);
                endMarker = null;
                endLocation = null;
            }
            
            routingMode = null;
            document.getElementById('start-location').value = '';
            document.getElementById('end-location').value = '';
            document.getElementById('route-info').classList.add('hidden');
            
            map.getContainer().style.cursor = '';
        }


        // Load custom layers
        function loadCustomLayers() {
            // Load roads
            fetch('/api/geo/roads')
                .then(response => response.json())
                .then(data => {
                    roadsLayer = L.geoJSON(data, {
                        style: {
                            color: '#3388ff',
                            weight: 4,
                            opacity: 0.8
                        },
                        onEachFeature: function(feature, layer) {
                            if (feature.properties) {
                                layer.bindPopup(`
                                    <strong>${feature.properties.name}</strong><br>
                                    ტიპი: ${feature.properties.type}<br>
                                    სიგრძე: ${feature.properties.length} კმ<br>
                                    მასალა: ${feature.properties.material}
                                `);
                            }
                        }
                    }).addTo(map);
                })
                .catch(error => console.log('Could not load roads:', error));

            // Load forests
            fetch('/api/geo/forests')
                .then(response => response.json())
                .then(data => {
                    forestsLayer = L.geoJSON(data, {
                        style: {
                            color: '#228B22',
                            weight: 2,
                            opacity: 0.8,
                            fillColor: '#90EE90',
                            fillOpacity: 0.4
                        },
                        onEachFeature: function(feature, layer) {
                            if (feature.properties) {
                                layer.bindPopup(`
                                    <strong>${feature.properties.name}</strong><br>
                                    ტიპი: ${feature.properties.type}<br>
                                    ფართობი: ${feature.properties.area} ჰა<br>
                                    სიმჭიდროვე: ${feature.properties.density}
                                `);
                            }
                        }
                    }).addTo(map);
                })
                .catch(error => console.log('Could not load forests:', error));

            // Load factories
            fetch('/api/geo/factories')
                .then(response => response.json())
                .then(data => {
                    factoriesLayer = L.geoJSON(data, {
                        pointToLayer: function(feature, latlng) {
                            return L.marker(latlng, {
                                icon: L.divIcon({
                                    className: 'factory-marker',
                                    html: `<div style="background: ${feature.properties.status === 'აქტიური' ? '#28a745' : '#dc3545'}; width: 20px; height: 20px; border-radius: 50%; border: 2px solid white; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 12px;">🏭</div>`
                                })
                            });
                        },
                        onEachFeature: function(feature, layer) {
                            if (feature.properties) {
                                layer.bindPopup(`
                                    <strong>${feature.properties.name}</strong><br>
                                    ტიპი: ${feature.properties.type}<br>
                                    მოცულობა: ${feature.properties.capacity}<br>
                                    სტატუსი: ${feature.properties.status}
                                `);
                            }
                        }
                    }).addTo(map);
                })
                .catch(error => console.log('Could not load factories:', error));
        }

        // Toggle layer visibility
        function toggleLayer(layerName) {
            const checkbox = document.getElementById(layerName + '-layer');
            const isChecked = checkbox.checked;

            switch(layerName) {
                case 'roads':
                    if (roadsLayer) {
                        if (isChecked) {
                            map.addLayer(roadsLayer);
                        } else {
                            map.removeLayer(roadsLayer);
                        }
                    }
                    break;
                case 'forests':
                    if (forestsLayer) {
                        if (isChecked) {
                            map.addLayer(forestsLayer);
                        } else {
                            map.removeLayer(forestsLayer);
                        }
                    }
                    break;
                case 'factories':
                    if (factoriesLayer) {
                        if (isChecked) {
                            map.addLayer(factoriesLayer);
                        } else {
                            map.removeLayer(factoriesLayer);
                        }
                    }
                    break;
            }
        }

        // Factory Management Functions
        function loadFactoryList() {
            fetch('/api/geo/factories')
                .then(response => response.json())
                .then(data => {
                    factoriesData = data.features;
                    const factoryList = document.getElementById('factory-list');
                    factoryList.innerHTML = '';
                    
                    data.features.forEach(feature => {
                        const div = document.createElement('div');
                        div.className = 'factory-item';
                        div.setAttribute('data-id', feature.properties.id);
                        div.innerHTML = `
                            <strong>${feature.properties.name}</strong><br>
                            <small>${feature.properties.type} - ${feature.properties.status}</small>
                        `;
                        div.onclick = () => selectFactory(feature.properties.id);
                        factoryList.appendChild(div);
                    });
                });
        }

        function selectFactory(factoryId) {
            selectedFactoryId = factoryId;
            
            // Update UI selection
            document.querySelectorAll('.factory-item').forEach(item => {
                item.classList.remove('selected');
            });
            document.querySelector(`[data-id="${factoryId}"]`).classList.add('selected');
            
            // Load factory data into form
            const factory = factoriesData.find(f => f.properties.id === factoryId);
            if (factory) {
                document.getElementById('factory-name').value = factory.properties.name;
                document.getElementById('factory-type').value = factory.properties.type;
                document.getElementById('factory-status').value = factory.properties.status;
                document.getElementById('factory-capacity').value = factory.properties.capacity;
                document.getElementById('factory-lat').value = factory.geometry.coordinates[1];
                document.getElementById('factory-lng').value = factory.geometry.coordinates[0];
                document.getElementById('delete-btn').style.display = 'inline-block';
            }
        }

        function saveFactory() {
            const factoryData = {
                name: document.getElementById('factory-name').value,
                type: document.getElementById('factory-type').value,
                status: document.getElementById('factory-status').value,
                capacity: parseInt(document.getElementById('factory-capacity').value),
                latitude: parseFloat(document.getElementById('factory-lat').value),
                longitude: parseFloat(document.getElementById('factory-lng').value)
            };

            if (!factoryData.name || !factoryData.type || !factoryData.status || 
                !factoryData.capacity || !factoryData.latitude || !factoryData.longitude) {
                alert('გთხოვთ შეავსოთ ყველა ველი');
                return;
            }

            const url = selectedFactoryId ? `/api/geo/factories/${selectedFactoryId}` : '/api/geo/factories';
            const method = selectedFactoryId ? 'PUT' : 'POST';

            fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(factoryData)
            })
            .then(response => response.json())
            .then(data => {
                alert(selectedFactoryId ? 'ქარხანა წარმატებით განახლდა!' : 'ქარხანა წარმატებით დაემატა!');
                clearForm();
                loadFactoryList();
                refreshFactoriesLayer();
            })
            .catch(error => {
                console.error('Error:', error);
                alert('შეცდომა: ქარხნის შენახვა ვერ მოხერხდა');
            });
        }

        function deleteSelectedFactory() {
            if (!selectedFactoryId) {
                alert('გთხოვთ აირჩიოთ ქარხანა წასაშლელად');
                return;
            }

            if (!confirm('დარწმუნებული ხართ რომ გსურთ ქარხნის წაშლა?')) {
                return;
            }

            fetch(`/api/geo/factories/${selectedFactoryId}`, {
                method: 'DELETE'
            })
            .then(response => {
                if (response.ok) {
                    alert('ქარხანა წარმატებით წაიშალა!');
                    clearForm();
                    loadFactoryList();
                    refreshFactoriesLayer();
                } else {
                    alert('შეცდომა: ქარხნის წაშლა ვერ მოხერხდა');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('შეცდომა: ქარხნის წაშლა ვერ მოხერხდა');
            });
        }

        function clearForm() {
            selectedFactoryId = null;
            document.getElementById('factory-name').value = '';
            document.getElementById('factory-type').value = '';
            document.getElementById('factory-status').value = '';
            document.getElementById('factory-capacity').value = '';
            document.getElementById('factory-lat').value = '';
            document.getElementById('factory-lng').value = '';
            document.getElementById('delete-btn').style.display = 'none';
            
            document.querySelectorAll('.factory-item').forEach(item => {
                item.classList.remove('selected');
            });
        }

        function refreshFactoriesLayer() {
            if (factoriesLayer) {
                map.removeLayer(factoriesLayer);
            }
            
            fetch('/api/geo/factories')
                .then(response => response.json())
                .then(data => {
                    factoriesLayer = L.geoJSON(data, {
                        pointToLayer: function(feature, latlng) {
                            return L.marker(latlng, {
                                icon: L.divIcon({
                                    className: 'factory-marker',
                                    html: `<div style="background: ${feature.properties.status === 'აქტიური' ? '#28a745' : '#dc3545'}; width: 20px; height: 20px; border-radius: 50%; border: 2px solid white; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 12px;">🏭</div>`
                                })
                            });
                        },
                        onEachFeature: function(feature, layer) {
                            if (feature.properties) {
                                layer.bindPopup(`
                                    <strong>${feature.properties.name}</strong><br>
                                    ტიპი: ${feature.properties.type}<br>
                                    მოცულობა: ${feature.properties.capacity}<br>
                                    სტატუსი: ${feature.properties.status}
                                `);
                            }
                        }
                    });
                    
                    if (document.getElementById('factories-layer').checked) {
                        factoriesLayer.addTo(map);
                    }
                })
                .catch(error => console.log('Could not refresh factories:', error));
        }

        // Check GeoServer status
        function checkGeoServerStatus() {
            fetch('/api/geo/geoserver/status')
                .then(response => response.json())
                .then(data => {
                    const statusDiv = document.getElementById('geoserver-status');
                    const indicator = document.getElementById('geoserver-indicator');
                    
                    if (data.connected) {
                        statusDiv.style.backgroundColor = '#d4edda';
                        statusDiv.style.color = '#155724';
                        indicator.textContent = '✅ ' + data.message;
                    } else {
                        statusDiv.style.backgroundColor = '#f8d7da';
                        statusDiv.style.color = '#721c24';
                        indicator.textContent = '❌ ' + data.message;
                    }
                })
                .catch(error => {
                    const statusDiv = document.getElementById('geoserver-status');
                    const indicator = document.getElementById('geoserver-indicator');
                    statusDiv.style.backgroundColor = '#f8d7da';
                    statusDiv.style.color = '#721c24';
                    indicator.textContent = '❌ GeoServer-ის სტატუსის შემოწმება ვერ მოხერხდა';
                });
        }

        // Panel management functions
        function togglePanel(panelId, iconElement) {
            // Close all other panels first
            document.querySelectorAll('.control-panel').forEach(panel => {
                if (panel.id !== panelId) {
                    panel.classList.remove('show');
                }
            });
            
            // Remove active state from all icons
            document.querySelectorAll('.control-icon').forEach(icon => {
                icon.classList.remove('active');
            });
            
            // Toggle the clicked panel
            const panel = document.getElementById(panelId);
            const isVisible = panel.classList.contains('show');
            
            if (isVisible) {
                panel.classList.remove('show');
            } else {
                panel.classList.add('show');
                iconElement.classList.add('active');
            }
        }

        function closePanel(panelId) {
            document.getElementById(panelId).classList.remove('show');
            document.querySelectorAll('.control-icon').forEach(icon => {
                icon.classList.remove('active');
            });
        }

        // Close panels when clicking on map
        map.on('click', function(e) {
            // Only close panels if not in routing mode
            if (!routingMode) {
                document.querySelectorAll('.control-panel').forEach(panel => {
                    panel.classList.remove('show');
                });
                document.querySelectorAll('.control-icon').forEach(icon => {
                    icon.classList.remove('active');
                });
            }
            
            // Handle routing clicks
            if (routingMode) {
                const latlng = e.latlng;
                
                if (routingMode === 'start') {
                    startLocation = latlng;
                    
                    if (startMarker) {
                        map.removeLayer(startMarker);
                    }
                    
                    startMarker = L.marker(latlng, {
                        icon: L.divIcon({
                            className: 'start-marker',
                            html: '<div style="background: #28a745; width: 20px; height: 20px; border-radius: 50%; border: 2px solid white; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 12px;">A</div>'
                        })
                    }).addTo(map);
                    
                    document.getElementById('start-location').value = `${latlng.lat.toFixed(6)}, ${latlng.lng.toFixed(6)}`;
                    
                } else if (routingMode === 'end') {
                    endLocation = latlng;
                    
                    if (endMarker) {
                        map.removeLayer(endMarker);
                    }
                    
                    endMarker = L.marker(latlng, {
                        icon: L.divIcon({
                            className: 'end-marker',
                            html: '<div style="background: #dc3545; width: 20px; height: 20px; border-radius: 50%; border: 2px solid white; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 12px;">B</div>'
                        })
                    }).addTo(map);
                    
                    document.getElementById('end-location').value = `${latlng.lat.toFixed(6)}, ${latlng.lng.toFixed(6)}`;
                }
                
                routingMode = null;
                map.getContainer().style.cursor = '';
            }
        });

        // Road Management Functions
        function loadRoadList() {
            fetch('/api/geo/roads')
                .then(response => response.json())
                .then(data => {
                    roadsData = data.features;
                    const roadList = document.getElementById('road-list');
                    roadList.innerHTML = '';
                    
                    data.features.forEach(feature => {
                        const div = document.createElement('div');
                        div.className = 'factory-item';
                        div.setAttribute('data-id', feature.properties.id);
                        div.innerHTML = `
                            <strong>${feature.properties.name}</strong><br>
                            <small>${feature.properties.type} - ${feature.properties.material}</small>
                        `;
                        div.onclick = () => selectRoad(feature.properties.id);
                        roadList.appendChild(div);
                    });
                });
        }

        function selectRoad(roadId) {
            selectedRoadId = roadId;
            
            // Update UI selection
            document.querySelectorAll('#road-list .factory-item').forEach(item => {
                item.classList.remove('selected');
            });
            document.querySelector(`#road-list [data-id="${roadId}"]`).classList.add('selected');
            
            // Load road data into form
            const road = roadsData.find(r => r.properties.id === roadId);
            if (road) {
                document.getElementById('road-name').value = road.properties.name;
                document.getElementById('road-type').value = road.properties.type;
                document.getElementById('road-material').value = road.properties.material;
                document.getElementById('road-startLat').value = road.geometry.coordinates[0][1];
                document.getElementById('road-startLng').value = road.geometry.coordinates[0][0];
                document.getElementById('road-endLat').value = road.geometry.coordinates[1][1];
                document.getElementById('road-endLng').value = road.geometry.coordinates[1][0];
                document.getElementById('road-length').value = road.properties.length;
                document.getElementById('road-delete-btn').style.display = 'inline-block';
            }
        }

        function saveRoad() {
            const roadData = {
                name: document.getElementById('road-name').value,
                type: document.getElementById('road-type').value,
                material: document.getElementById('road-material').value,
                startLat: parseFloat(document.getElementById('road-startLat').value),
                startLng: parseFloat(document.getElementById('road-startLng').value),
                endLat: parseFloat(document.getElementById('road-endLat').value),
                endLng: parseFloat(document.getElementById('road-endLng').value),
                length: parseFloat(document.getElementById('road-length').value)
            };

            if (!roadData.name || !roadData.type || !roadData.material || 
                !roadData.startLat || !roadData.startLng || !roadData.endLat || !roadData.endLng) {
                alert('გთხოვთ შეავსოთ ყველა ველი');
                return;
            }

            const url = selectedRoadId ? `/api/geo/roads/${selectedRoadId}` : '/api/geo/roads';
            const method = selectedRoadId ? 'PUT' : 'POST';

            fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(roadData)
            })
            .then(response => response.json())
            .then(data => {
                alert(selectedRoadId ? 'გზა წარმატებით განახლდა!' : 'გზა წარმატებით დაემატა!');
                clearRoadForm();
                loadRoadList();
                refreshRoadsLayer();
            })
            .catch(error => {
                console.error('Error:', error);
                alert('შეცდომა: გზის შენახვა ვერ მოხერხდა');
            });
        }

        function deleteSelectedRoad() {
            if (!selectedRoadId) {
                alert('გთხოვთ აირჩიოთ გზა წასაშლელად');
                return;
            }

            if (!confirm('დარწმუნებული ხართ რომ გსურთ გზის წაშლა?')) {
                return;
            }

            fetch(`/api/geo/roads/${selectedRoadId}`, {
                method: 'DELETE'
            })
            .then(response => {
                if (response.ok) {
                    alert('გზა წარმატებით წაიშალა!');
                    clearRoadForm();
                    loadRoadList();
                    refreshRoadsLayer();
                } else {
                    alert('შეცდომა: გზის წაშლა ვერ მოხერხდა');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('შეცდომა: გზის წაშლა ვერ მოხერხდა');
            });
        }

        function clearRoadForm() {
            selectedRoadId = null;
            document.getElementById('road-name').value = '';
            document.getElementById('road-type').value = '';
            document.getElementById('road-material').value = '';
            document.getElementById('road-startLat').value = '';
            document.getElementById('road-startLng').value = '';
            document.getElementById('road-endLat').value = '';
            document.getElementById('road-endLng').value = '';
            document.getElementById('road-length').value = '';
            document.getElementById('road-delete-btn').style.display = 'none';
            
            document.querySelectorAll('#road-list .factory-item').forEach(item => {
                item.classList.remove('selected');
            });
        }

        function refreshRoadsLayer() {
            if (roadsLayer) {
                map.removeLayer(roadsLayer);
            }
            
            fetch('/api/geo/roads')
                .then(response => response.json())
                .then(data => {
                    roadsLayer = L.geoJSON(data, {
                        style: {
                            color: '#3388ff',
                            weight: 4,
                            opacity: 0.8
                        },
                        onEachFeature: function(feature, layer) {
                            if (feature.properties) {
                                layer.bindPopup(`
                                    <strong>${feature.properties.name}</strong><br>
                                    ტიპი: ${feature.properties.type}<br>
                                    სიგრძე: ${feature.properties.length} კმ<br>
                                    მასალა: ${feature.properties.material}
                                `);
                            }
                        }
                    });
                    
                    if (document.getElementById('roads-layer').checked) {
                        roadsLayer.addTo(map);
                    }
                })
                .catch(error => console.log('Could not refresh roads:', error));
        }

        // Forest Management Functions
        function loadForestList() {
            fetch('/api/geo/forests')
                .then(response => response.json())
                .then(data => {
                    forestsData = data.features;
                    const forestList = document.getElementById('forest-list');
                    forestList.innerHTML = '';
                    
                    data.features.forEach(feature => {
                        const div = document.createElement('div');
                        div.className = 'factory-item';
                        div.setAttribute('data-id', feature.properties.id);
                        div.innerHTML = `
                            <strong>${feature.properties.name}</strong><br>
                            <small>${feature.properties.type} - ${feature.properties.status}</small>
                        `;
                        div.onclick = () => selectForest(feature.properties.id);
                        forestList.appendChild(div);
                    });
                });
        }

        function selectForest(forestId) {
            selectedForestId = forestId;
            
            // Update UI selection
            document.querySelectorAll('#forest-list .factory-item').forEach(item => {
                item.classList.remove('selected');
            });
            document.querySelector(`#forest-list [data-id="${forestId}"]`).classList.add('selected');
            
            // Load forest data into form
            const forest = forestsData.find(f => f.properties.id === forestId);
            if (forest) {
                document.getElementById('forest-name').value = forest.properties.name;
                document.getElementById('forest-type').value = forest.properties.type;
                document.getElementById('forest-density').value = forest.properties.density;
                document.getElementById('forest-status').value = forest.properties.status;
                document.getElementById('forest-area').value = forest.properties.area;
                document.getElementById('forest-centerLat').value = forest.geometry.coordinates[1];
                document.getElementById('forest-centerLng').value = forest.geometry.coordinates[0];
                document.getElementById('forest-delete-btn').style.display = 'inline-block';
            }
        }

        function saveForest() {
            const forestData = {
                name: document.getElementById('forest-name').value,
                type: document.getElementById('forest-type').value,
                density: document.getElementById('forest-density').value,
                status: document.getElementById('forest-status').value,
                area: parseFloat(document.getElementById('forest-area').value),
                centerLat: parseFloat(document.getElementById('forest-centerLat').value),
                centerLng: parseFloat(document.getElementById('forest-centerLng').value),
                coordinates: null
            };

            if (!forestData.name || !forestData.type || !forestData.density || !forestData.status || 
                !forestData.area || !forestData.centerLat || !forestData.centerLng) {
                alert('გთხოვთ შეავსოთ ყველა ველი');
                return;
            }

            const url = selectedForestId ? `/api/geo/forests/${selectedForestId}` : '/api/geo/forests';
            const method = selectedForestId ? 'PUT' : 'POST';

            fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(forestData)
            })
            .then(response => response.json())
            .then(data => {
                alert(selectedForestId ? 'ტყე წარმატებით განახლდა!' : 'ტყე წარმატებით დაემატა!');
                clearForestForm();
                loadForestList();
                refreshForestsLayer();
            })
            .catch(error => {
                console.error('Error:', error);
                alert('შეცდომა: ტყის შენახვა ვერ მოხერხდა');
            });
        }

        function deleteSelectedForest() {
            if (!selectedForestId) {
                alert('გთხოვთ აირჩიოთ ტყე წასაშლელად');
                return;
            }

            if (!confirm('დარწმუნებული ხართ რომ გსურთ ტყის წაშლა?')) {
                return;
            }

            fetch(`/api/geo/forests/${selectedForestId}`, {
                method: 'DELETE'
            })
            .then(response => {
                if (response.ok) {
                    alert('ტყე წარმატებით წაიშალა!');
                    clearForestForm();
                    loadForestList();
                    refreshForestsLayer();
                } else {
                    alert('შეცდომა: ტყის წაშლა ვერ მოხერხდა');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('შეცდომა: ტყის წაშლა ვერ მოხერხდა');
            });
        }

        function clearForestForm() {
            selectedForestId = null;
            document.getElementById('forest-name').value = '';
            document.getElementById('forest-type').value = '';
            document.getElementById('forest-density').value = '';
            document.getElementById('forest-status').value = '';
            document.getElementById('forest-area').value = '';
            document.getElementById('forest-centerLat').value = '';
            document.getElementById('forest-centerLng').value = '';
            document.getElementById('forest-delete-btn').style.display = 'none';
            
            document.querySelectorAll('#forest-list .factory-item').forEach(item => {
                item.classList.remove('selected');
            });
        }

        function refreshForestsLayer() {
            if (forestsLayer) {
                map.removeLayer(forestsLayer);
            }
            
            fetch('/api/geo/forests')
                .then(response => response.json())
                .then(data => {
                    forestsLayer = L.geoJSON(data, {
                        style: {
                            color: '#228B22',
                            weight: 2,
                            opacity: 0.8,
                            fillColor: '#90EE90',
                            fillOpacity: 0.4
                        },
                        onEachFeature: function(feature, layer) {
                            if (feature.properties) {
                                layer.bindPopup(`
                                    <strong>${feature.properties.name}</strong><br>
                                    ტიპი: ${feature.properties.type}<br>
                                    ფართობი: ${feature.properties.area} ჰა<br>
                                    სიმჭიდროვე: ${feature.properties.density}
                                `);
                            }
                        }
                    });
                    
                    if (document.getElementById('forests-layer').checked) {
                        forestsLayer.addTo(map);
                    }
                })
                .catch(error => console.log('Could not refresh forests:', error));
        }

        // Load layers when map is ready
        setTimeout(() => {
            loadCustomLayers();
            loadFactoryList();
            loadRoadList();
            loadForestList();
            checkGeoServerStatus();
        }, 1000);

        console.log('✅ Map loaded successfully!');
    </script>
</body>
</html>